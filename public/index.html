<!DOCTYPE html>
<html>
<head>
    <title>Screen Share App</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #000;
            color: #fff;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            overflow-x: hidden;
        }

        #welcome-container {
            text-align: center;
            position: relative;
            margin-top: 20px;
        }

        #welcome-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, transparent, violet, transparent);
            pointer-events: none;
            z-index: -1;
            animation: moveLines 5s linear infinite;
        }

        @keyframes moveLines {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        #code-section {
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }

        #room-code {
            padding: 10px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: #333;
            color: #fff;
            margin-right: 10px;
        }

        #join-btn, #create-btn {
            padding: 10px 20px;
            background-color: violet;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        #video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            width: 90%;
            max-width: 1200px;
            margin-top: 20px;
        }

        video {
            width: 100%;
            height: auto;
            background-color: #222;
            border-radius: 5px;
        }

        #screen-share-section {
            margin-top: 20px;
            width: 90%;
            max-width: 1200px;
        }

        #controls {
            margin-top: 20px;
        }

        #controls button {
            background-color: #333;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
        }

        #controls button img {
            width: 24px;
            height: 24px;
        }

        .participant {
            position: relative;
        }

        .participant-name {
            position: absolute;
            bottom: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px;
        }

        .muted-video::after, .muted-audio::after {
            content: '\uD83D\uDD07';
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px;
        }

        #screen-share-btn {
            background-color: violet;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            margin-top: 10px;
        }

        #leave-btn {
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
        }

        #generated-code {
            font-size: 24px;
            font-weight: bold;
            color: violet;
            margin: 15px 0;
        }

        #code-display {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: rgba(128, 0, 128, 0.2);
            border-radius: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(128, 0, 128, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(128, 0, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(128, 0, 128, 0); }
        }

        #copy-code {
            background-color: #555;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            margin-left: 10px;
        }

        #copy-code:hover {
            background-color: #777;
        }
    </style>
</head>
<body>
    <div id="welcome-container">
        <h1>Welcome to Screen Share</h1>
        <div id="code-section">
            <input type="text" id="room-code" placeholder="Enter Room Code">
            <button id="join-btn">Join Room</button>
            <button id="create-btn">Create Room</button>
            <div id="code-display">
                <p>Your room code:</p>
                <p id="generated-code"></p>
                <button id="copy-code">Copy Code</button>
                <p>Share this code with others to join your room</p>
            </div>
        </div>
    </div>
    <div id="video-grid" style="display: none;">
        <div class="participant">
            <video id="local-video" muted autoplay></video>
            <span class="participant-name">You</span>
        </div>
    </div>
    <div id="screen-share-section" style="display: none;">
        <video id="screen-share-video" autoplay></video>
        <button id="screen-share-btn">Share Screen</button>
    </div>
    <div id="controls" style="display: none;">
        <button id="video-toggle"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M17 10.5V7a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-3.5l4 4v-11l-4 4z'/%3E%3C/svg%3E" alt="Video"></button>
        <button id="audio-toggle"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 2C9.11 2 7 4.11 7 7v10c0 2.89 2.11 5 5 5'/%3E%3C/svg%3E" alt="Audio"></button>
        <button id="leave-btn">Leave Room</button>
    </div>

    <script>
        const roomCodeInput = document.getElementById('room-code');
        const joinButton = document.getElementById('join-btn');
        const createButton = document.getElementById('create-btn');
        const generatedCode = document.getElementById('generated-code');
        const codeDisplay = document.getElementById('code-display');
        const copyCodeButton = document.getElementById('copy-code');
        const localVideo = document.getElementById('local-video');
        const videoGridElement = document.getElementById('video-grid');
        const screenShareVideo = document.getElementById('screen-share-video');
        const screenShareButton = document.getElementById('screen-share-btn');
        const screenShareSectionElement = document.getElementById('screen-share-section');
        const controlsElement = document.getElementById('controls');
        const videoToggle = document.getElementById('video-toggle');
        const audioToggle = document.getElementById('audio-toggle');
        const leaveButton = document.getElementById('leave-btn');
        const welcomeContainer = document.getElementById("welcome-container");

        let localStream;
        let screenStream;
        let isScreenSharing = false;
        let peerConnections = {};
        let roomCode;
        let socket;
        let iceServers;

        let videoEnabled = true;
        let audioEnabled = true;

        async function fetchIceServers() {
            try {
                const response = await fetch("https://vexcall.metered.live/api/v1/turn/credentials?apiKey=61f91be5437bb44e00aab585d5f744ae5234");
                iceServers = await response.json();
                console.log("TURN Servers fetched:", iceServers);
            } catch (error) {
                console.error("Failed to fetch TURN servers:", error);
                iceServers = {
                    iceServers: [
                        { urls: 'stun:74.125.192.127:19302' },  // stun.l.google.com
                        { urls: 'stun:172.217.192.127:19302' }, // stun1.l.google.com
                        { urls: 'stun:142.250.15.127:19302' },  // stun2.l.google.com
                        { urls: 'stun:108.177.15.127:19302' },  // stun3.l.google.com
                        { urls: 'stun:108.177.119.127:19302' }  // stun4.l.google.com
                    ]
                }; // Fallback to STUN servers if TURN fetch fails
            }
        }

        // Connect to websocket server
        function connectSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const wsUrl = protocol + window.location.host;
            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                console.log('Connected to signaling server');
            };

            socket.onmessage = async (event) => {
                const message = JSON.parse(event.data);

                switch(message.type) {
                    case 'room-created':
                        roomCode = message.roomCode;
                        generatedCode.textContent = roomCode;
                        codeDisplay.style.display = 'block';
                        await initLocalStream();
                        joinRoom(roomCode);
                        break;

                    case 'user-joined':
                        console.log('User joined room', message.userId);
                        await createPeerConnection(message.userId);
                        sendOffer(message.userId);
                        break;

                    case 'user-left':
                        if (peerConnections[message.userId]) {
                            removeVideoElement(message.userId);
                            peerConnections[message.userId].close();
                            delete peerConnections[message.userId];
                        }
                        break;

                    case 'offer':
                        handleOffer(message);
                        break;

                    case 'answer':
                        handleAnswer(message);
                        break;

                    case 'ice-candidate':
                        handleICECandidate(message);
                        break;

                    case 'screen-share-started':
                        handleRemoteScreenShare(message.userId, true);
                        break;

                    case 'screen-share-stopped':
                        handleRemoteScreenShare(message.userId, false);
                        break;

                    case 'error':
                        alert(message.message);
                        break;
                }
            };

            socket.onclose = () => {
                console.log('Disconnected from signaling server');
            };

            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
                alert('WebSocket connection error. Please try again.');
                // Add reconnect logic here if needed
            };
        }

        // Copy room code to clipboard
        copyCodeButton.addEventListener('click', () => {
            navigator.clipboard.writeText(roomCode).then(() => {
                copyCodeButton.textContent = 'Copied!';
                setTimeout(() => {
                    copyCodeButton.textContent = 'Copy Code';
                }, 2000);
            }).catch(err => {
                console.error('Could not copy text: ', err);
            });
        });

        // Create a new room
        createButton.addEventListener('click', async () => {
            await fetchIceServers();
            connectSocket();
            socket.onopen = () => {
                socket.send(JSON.stringify({
                    type: 'create-room'
                }));
            };

            videoGridElement.style.display = "grid";
            screenShareSectionElement.style.display = "block";
            controlsElement.style.display = "block";
        });

        // Join an existing room
        joinButton.addEventListener('click', async () => {
            roomCode = roomCodeInput.value.trim();
            if (!roomCode) {
                alert('Please enter a room code');
                return;
            }
            await fetchIceServers();
            connectSocket();
            socket.onopen = async () => {
                await initLocalStream();
                joinRoom(roomCode);
            };

            welcomeContainer.style.display = "none";
            videoGridElement.style.display = "grid";
            screenShareSectionElement.style.display = "block";
            controlsElement.style.display = "block";
        });

        // Initialize local media stream
        async function initLocalStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                localVideo.srcObject = localStream;
            } catch (error) {
                console.error('Error getting user media:', error);
                alert('Unable to access camera or microphone. Please check permissions.');
            }
        }

        // Join a room with the given code
        function joinRoom(code) {
            socket.send(JSON.stringify({
                type: 'join-room',
                roomCode: code
            }));
        }

        // Create a peer connection for a specific user
        async function createPeerConnection(userId) {
            const pc = new RTCPeerConnection(iceServers);
            peerConnections[userId] = pc;

            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.send(JSON.stringify({
                        type: 'ice-candidate',
                        candidate: event.candidate,
                        userId: userId
                    }));
                }
            };

            pc.ontrack = (event) => {
                if (!document.getElementById(`remote-video-${userId}`)) {
                    const remoteVideo = document.createElement('video');
                    remoteVideo.id = `remote-video-${userId}`;
                    remoteVideo.autoplay = true;
                    remoteVideo.playsInline = true;

                    const participantDiv = document.createElement('div');
                    participantDiv.id = `participant-${userId}`;
                    participantDiv.className = 'participant';

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'participant-name';
                    nameSpan.textContent = `User ${userId.substring(0, 5)}`;

                    participantDiv.appendChild(remoteVideo);
                    participantDiv.appendChild(nameSpan);
                    videoGridElement.appendChild(participantDiv);
                }

                const remoteVideo = document.getElementById(`remote-video-${userId}`);
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };

            pc.oniceconnectionstatechange = () => {
                console.log("ICE connection state changed to: ", pc.iceConnectionState);
            }

            pc.onconnectionstatechange = () => {
                console.log("connection state changed to: ", pc.connectionState);
            }

            pc.onerror = (error) => {
                console.error("Peer connection error: ", error);
            }

            return pc;
        }

        // Send an offer to a specific user
        async function sendOffer(userId) {
            const pc = peerConnections[userId];
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            socket.send(JSON.stringify({
                type: 'offer',
                offer: offer,
                userId: userId
            }));
        }

        // Handle an incoming offer
        async function handleOffer(message) {
            const userId = message.userId;

            if (!peerConnections[userId]) {
                await createPeerConnection(userId);
            }

            const pc = peerConnections[userId];
            await pc.setRemoteDescription(new RTCSessionDescription(message.offer));

            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            socket.send(JSON.stringify({
                type: 'answer',
                answer: answer,
                userId: userId
            }));
        }

        // Handle an incoming answer
        async function handleAnswer(message) {
            const pc = peerConnections[message.userId];
            if (pc) {
                await pc.setRemoteDescription(new RTCSessionDescription(message.answer));
            }
        }

        // Handle an incoming ICE candidate
        async function handleICECandidate(message) {
            const pc = peerConnections[message.userId];
            if (pc) {
                await pc.addIceCandidate(new RTCIceCandidate(message.candidate));
            }
        }

        // Remove a video element when a user leaves
        function removeVideoElement(userId) {
            const participantEl = document.getElementById(`participant-${userId}`);
            if (participantEl) {
                participantEl.remove();
            }
        }

        // Toggle video
        videoToggle.addEventListener('click', () => {
            videoEnabled = !videoEnabled;
            localStream.getVideoTracks().forEach(track => {
                track.enabled = videoEnabled;
            });
            videoToggle.style.backgroundColor = videoEnabled ? '#333' : '#ff4444';
        });

        // Toggle audio
        audioToggle.addEventListener('click', () => {
            audioEnabled = !audioEnabled;
            localStream.getAudioTracks().forEach(track => {
                track.enabled = audioEnabled;
            });
            audioToggle.style.backgroundColor = audioEnabled ? '#333' : '#ff4444';
        });

        // Screen sharing
        screenShareButton.addEventListener('click', async () => {
            if (!isScreenSharing) {
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true
                    });
                    screenShareVideo.srcObject = screenStream;
                    screenShareVideo.style.display = 'block';
                    isScreenSharing = true;
                    screenShareButton.textContent = 'Stop Sharing';

                    socket.send(JSON.stringify({
                        type: 'screen-share-started',
                        roomCode: roomCode
                    }));

                    const videoTrack = screenStream.getVideoTracks()[0];
                    Object.values(peerConnections).forEach(pc => {
                        const senders = pc.getSenders();
                        const sender = senders.find(s => s.track && s.track.kind === 'video');
                        if (sender) {
                            sender.replaceTrack(videoTrack);
                        }
                    });

                    videoTrack.onended = () => {
                        stopScreenSharing();
                    };
                } catch (error) {
                    console.error('Error starting screen share:', error);
                    alert("Screen sharing error, please try again.");
                }
            } else {
                stopScreenSharing();
            }
        });

        // Stop screen sharing
        function stopScreenSharing() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenShareVideo.srcObject = null;
                screenShareVideo.style.display = 'none';
                isScreenSharing = false;
                screenShareButton.textContent = 'Share Screen';

                socket.send(JSON.stringify({
                    type: 'screen-share-stopped',
                    roomCode: roomCode
                }));

                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    Object.values(peerConnections).forEach(pc => {
                        const senders = pc.getSenders();
                        const sender = senders.find(s => s.track && s.track.kind === 'video');
                        if (sender) {
                            sender.replaceTrack(videoTrack);
                        }
                    });
                }
            }
        }

        // Handle remote screen sharing
        function handleRemoteScreenShare(userId, isSharing) {
            const remoteVideo = document.getElementById(`remote-video-${userId}`);
            if (remoteVideo) {
                if (isSharing) {
                    remoteVideo.style.border = '2px solid violet';
                } else {
                    remoteVideo.style.border = 'none';
                }
            }
        }

        // Leave the room
        leaveButton.addEventListener('click', () => {
            socket.send(JSON.stringify({
                type: 'leave-room',
                roomCode: roomCode
            }));

            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }

            welcomeContainer.style.display = "block";
            codeDisplay.style.display = "none";
            videoGridElement.style.display = "none";
            screenShareSectionElement.style.display = "none";
            controlsElement.style.display = "none";

            const participants = document.querySelectorAll('.participant:not(:first-child)');
            participants.forEach(p => p.remove());

            localVideo.srcObject = null;
            screenShareVideo.srcObject = null;

            socket.close();
        });
    </script>
</body>
</html>
